<!doctype html><html lang=zh-TW><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Kolla-Ansible Nova Ephemeral Storage on NFS - 伊達's work</title><meta name=Description content><meta property="og:url" content="https://blog.kojuro.date/2018/10/2018-10-18-kolla-ansible-nova-ephemeral-storage-on-nfs/"><meta property="og:site_name" content="伊達's work"><meta property="og:title" content="Kolla-Ansible Nova Ephemeral Storage on NFS"><meta property="og:description" content="OpenStack 通常會有兩種儲存 VM 的方式，一個是直接在 Nova-Compute Node 上面的 /var/lib/nova/instances ，另外一種則是儲存在 Cinder。前者通常也不會真的直接儲存在 Node 上，而是會透過 Shared Storage 儲存，例如 NFS 等等。
但是因為 OpenStack 會有一些 Lock 機制，偏偏 NFS 不一定實作全部的 Lock 種類，所以會導致 Lock 失敗，進而製作 VM 也跟著失敗。
Nova 在新增 VM 或是複製 Image 的時候，會考慮處理程序處理的問題，所以會使用 Lock ，以確保沒有正確無誤。透過 oslo.concurrency 處理 Lock，底層透過 fasteners 呼叫 fcntl ，進而失敗。所以我們將 Lock 機制暫時取消掉。目前還無法確定取消掉之後會不會有其他問題存在。"><meta property="og:locale" content="zh_TW"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-10-17T17:23:08+00:00"><meta property="article:modified_time" content="2022-07-09T23:20:26+08:00"><meta property="og:image" content="https://blog.kojuro.date/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.kojuro.date/logo.png"><meta name=twitter:title content="Kolla-Ansible Nova Ephemeral Storage on NFS"><meta name=twitter:description content="OpenStack 通常會有兩種儲存 VM 的方式，一個是直接在 Nova-Compute Node 上面的 /var/lib/nova/instances ，另外一種則是儲存在 Cinder。前者通常也不會真的直接儲存在 Node 上，而是會透過 Shared Storage 儲存，例如 NFS 等等。
但是因為 OpenStack 會有一些 Lock 機制，偏偏 NFS 不一定實作全部的 Lock 種類，所以會導致 Lock 失敗，進而製作 VM 也跟著失敗。
Nova 在新增 VM 或是複製 Image 的時候，會考慮處理程序處理的問題，所以會使用 Lock ，以確保沒有正確無誤。透過 oslo.concurrency 處理 Lock，底層透過 fasteners 呼叫 fcntl ，進而失敗。所以我們將 Lock 機制暫時取消掉。目前還無法確定取消掉之後會不會有其他問題存在。"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.kojuro.date/2018/10/2018-10-18-kolla-ansible-nova-ephemeral-storage-on-nfs/><link rel=prev href=https://blog.kojuro.date/2018/10/2018-10-17-openstack-rocky-cinder-nfs-driver-issue/><link rel=next href=https://blog.kojuro.date/2018/10/patch-kolla-via-template/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Kolla-Ansible Nova Ephemeral Storage on NFS","inLanguage":"zh-TW","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.kojuro.date\/2018\/10\/2018-10-18-kolla-ansible-nova-ephemeral-storage-on-nfs\/"},"image":["https:\/\/blog.kojuro.date\/images\/Apple-Devices-Preview.png"],"genre":"posts","wordcount":320,"url":"https:\/\/blog.kojuro.date\/2018\/10\/2018-10-18-kolla-ansible-nova-ephemeral-storage-on-nfs\/","datePublished":"2018-10-17T17:23:08+00:00","dateModified":"2022-07-09T23:20:26+08:00","publisher":{"@type":"Organization","name":"xxxx","logo":"https:\/\/blog.kojuro.date\/images\/avatar.png"},"author":{"@type":"Person","name":"Date Huang"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="伊達's work">伊達's work</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切換主題>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="伊達's work">伊達's work</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title=切換主題>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目錄</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Kolla-Ansible Nova Ephemeral Storage on NFS</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Date Huang</a></span>&nbsp;<span class=post-category>收錄於 <a href=/categories/openstack/><i class="far fa-folder fa-fw" aria-hidden=true></i>Openstack</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2018-10-17>2018-10-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;約 320 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;預計閱讀 1 分鐘&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目錄</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents></nav></div></div><div class=content id=content><p>OpenStack 通常會有兩種儲存 VM 的方式，一個是直接在 Nova-Compute Node 上面的 <code>/var/lib/nova/instances</code> ，另外一種則是儲存在 Cinder。前者通常也不會真的直接儲存在 Node 上，而是會透過 Shared Storage 儲存，例如 NFS 等等。</p><p>但是因為 OpenStack 會有一些 Lock 機制，偏偏 NFS 不一定實作全部的 Lock 種類，所以會導致 Lock 失敗，進而製作 VM 也跟著失敗。</p><p>Nova 在新增 VM 或是複製 Image 的時候，會考慮處理程序處理的問題，所以會使用 Lock ，以確保沒有正確無誤。透過 oslo.concurrency 處理 Lock，底層透過 fasteners 呼叫 fcntl ，進而失敗。所以我們將 Lock 機制暫時取消掉。目前還無法確定取消掉之後會不會有其他問題存在。</p><p>在 <code>/etc/kolla/nova.conf</code> 中，加入以下設定，將 Lock 關閉</p><pre class=wp-block-code><code># /etc/kolla/nova.conf
[oslo_concurrency]
disable_process_locking = True</code></pre><p>接下來，直接在 Host 中掛載 NFS ，例如：</p><pre class=wp-block-code><code># Nova-Compute Host
mount -t nfs 172.x.x.x:/export/openstack /srv/nfs/openstack</code></pre><p>然後設定 <code>/etc/kolla/globals.yml</code> ，掛載 NFS 目錄進 Container 之中</p><pre class=wp-block-code><code># /etc/kolla/globals.yml
nova_instance_datadir_volume: "/srv/nfs/openstack/"</code></pre><p>並且依據先前調整 <a href=https://blog.kojuro.date/openstack-rocky-cinder-nfs-driver-issue/ target=_blank rel="noopener noreffer">Cinder-Volume NFS Driver</a>，對 QEMU 相關的修改即可。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新於 2022-07-09&nbsp;<a class=git-hash href=https://github.com/dillonzq/LoveIt/commit/2c653453dff7ea4c55a8d6fe89b3aee382d7a10a target=_blank title="commit by Date Huang(tjjh89017@hotmail.com) 2c653453dff7ea4c55a8d6fe89b3aee382d7a10a: upload wordpress posts">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>2c65345</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2018/10/2018-10-18-kolla-ansible-nova-ephemeral-storage-on-nfs/index.md target=_blank>閱讀原始文檔</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://blog.kojuro.date/2018/10/2018-10-18-kolla-ansible-nova-ephemeral-storage-on-nfs/ data-title="Kolla-Ansible Nova Ephemeral Storage on NFS"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://blog.kojuro.date/2018/10/2018-10-18-kolla-ansible-nova-ephemeral-storage-on-nfs/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://blog.kojuro.date/2018/10/2018-10-18-kolla-ansible-nova-ephemeral-storage-on-nfs/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主頁</a></span></section></div><div class=post-nav><a href=/2018/10/2018-10-17-openstack-rocky-cinder-nfs-driver-issue/ class=prev rel=prev title="OpenStack Rocky Cinder NFS Driver Issue"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>OpenStack Rocky Cinder NFS Driver Issue</a>
<a href=/2018/10/patch-kolla-via-template/ class=next rel=next title="Patch Kolla via Template">Patch Kolla via Template<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.151.0">Hugo</a> 強力驅動 | 主題 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span>&nbsp;|&nbsp;<span class=license>All Rights Reserved</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到頂部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看評論><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"複製到剪貼板",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1YYWDWN3ZY",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-1YYWDWN3ZY" async></script></body></html>