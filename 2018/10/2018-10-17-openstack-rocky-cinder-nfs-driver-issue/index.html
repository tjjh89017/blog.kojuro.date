<!doctype html><html lang=zh-TW><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>OpenStack Rocky Cinder NFS Driver Issue - 伊達's work</title><meta name=Description content><meta property="og:url" content="https://blog.kojuro.date/2018/10/2018-10-17-openstack-rocky-cinder-nfs-driver-issue/"><meta property="og:site_name" content="伊達's work"><meta property="og:title" content="OpenStack Rocky Cinder NFS Driver Issue"><meta property="og:description" content="最近使用 Kolla-Ansible 部署 OpenStack Rocky on AArch64/ARM64 發生一些問題，這問題並不只是存在 ARM 上，而是因為發行版所維護的 QEMU 版本已經跟到了 commit ca749954b09b89e22cd69c4949fb7e689b057963 ，這個 commit 使用到了 F_OFD_SETLK， NFSv3 正好不支援這類型 lock 操作。
而這個修改，並沒有根據不同檔案系統不支援 F_OFD_SETLK 回退 F_SETLK 的操作，所以只要在現代 Linux 中編譯 QEMU，就會直接使用 F_OFD_SETLK ，而造成在 NFSv3 上無法使用 lock 進而導致失敗的現象。
而這問題也不單單只影響 Cinder-Volume，也間接影響 Nova-Compute，如果 VM 要掛載 Volume，而 Cinder 使用 NFS Driver，則會在 Nova-Compute 上也把 NFS 掛載上去給 QEMU 使用。"><meta property="og:locale" content="zh_TW"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-10-17T07:35:59+00:00"><meta property="article:modified_time" content="2022-07-09T23:20:26+08:00"><meta property="og:image" content="https://blog.kojuro.date/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.kojuro.date/logo.png"><meta name=twitter:title content="OpenStack Rocky Cinder NFS Driver Issue"><meta name=twitter:description content="最近使用 Kolla-Ansible 部署 OpenStack Rocky on AArch64/ARM64 發生一些問題，這問題並不只是存在 ARM 上，而是因為發行版所維護的 QEMU 版本已經跟到了 commit ca749954b09b89e22cd69c4949fb7e689b057963 ，這個 commit 使用到了 F_OFD_SETLK， NFSv3 正好不支援這類型 lock 操作。
而這個修改，並沒有根據不同檔案系統不支援 F_OFD_SETLK 回退 F_SETLK 的操作，所以只要在現代 Linux 中編譯 QEMU，就會直接使用 F_OFD_SETLK ，而造成在 NFSv3 上無法使用 lock 進而導致失敗的現象。
而這問題也不單單只影響 Cinder-Volume，也間接影響 Nova-Compute，如果 VM 要掛載 Volume，而 Cinder 使用 NFS Driver，則會在 Nova-Compute 上也把 NFS 掛載上去給 QEMU 使用。"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=referrer content="no-referrer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.kojuro.date/2018/10/2018-10-17-openstack-rocky-cinder-nfs-driver-issue/><link rel=prev href=https://blog.kojuro.date/2018/10/2018-10-14-openstack-on-aarch64-arm64-via-kolla-ansible/><link rel=next href=https://blog.kojuro.date/2018/10/2018-10-18-kolla-ansible-nova-ephemeral-storage-on-nfs/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"OpenStack Rocky Cinder NFS Driver Issue","inLanguage":"zh-TW","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.kojuro.date\/2018\/10\/2018-10-17-openstack-rocky-cinder-nfs-driver-issue\/"},"genre":"posts","wordcount":968,"url":"https:\/\/blog.kojuro.date\/2018\/10\/2018-10-17-openstack-rocky-cinder-nfs-driver-issue\/","datePublished":"2018-10-17T07:35:59+00:00","dateModified":"2022-07-09T23:20:26+08:00","publisher":{"@type":"Organization","name":"Date Huang","logo":"https:\/\/blog.kojuro.date\/images\/avatar.png"},"author":{"@type":"Person","name":"Date Huang"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>const query=window.matchMedia("(prefers-color-scheme: dark)");function applyTheme(){let e=window.localStorage?.getItem("theme")||"auto",t=e==="dark"||e==="auto"&&query.matches;document.body.setAttribute("theme",t?"dark":"light"),document.body.setAttribute("cfg-theme",e)}applyTheme(),query.addEventListener("change",applyTheme)</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="伊達's work">伊達's work</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切換主題>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="伊達's work">伊達's work</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title=切換主題>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目錄</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">OpenStack Rocky Cinder NFS Driver Issue</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Date Huang</a></span>&nbsp;<span class=post-category>收錄於 <a href=/categories/openstack/><i class="far fa-folder fa-fw" aria-hidden=true></i>Openstack</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2018-10-17>2018-10-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;約 968 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;預計閱讀 2 分鐘&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目錄</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#kolla-cinder-nfsv3-lock-failed><span class=ez-toc-section id=Kolla_Cinder_NFSv3_Lock_Failed></span>Kolla Cinder NFSv3 Lock Failed<span class=ez-toc-section-end></span></a><ul><li><a href=#問題><span class=ez-toc-section id=%E5%95%8F%E9%A1%8C></span>問題<span class=ez-toc-section-end></span></a></li><li><a href=#解決方法><span class=ez-toc-section id=%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95></span>解決方法<span class=ez-toc-section-end></span></a></li></ul></li><li><a href=#qemu-failed-to-lock-byte-100><span class=ez-toc-section id=QEMU_Failed_to_lock_byte_100></span>QEMU Failed to lock byte 100<span class=ez-toc-section-end></span></a><ul><li><a href=#問題-1><span class=ez-toc-section id=%E5%95%8F%E9%A1%8C-2></span>問題<span class=ez-toc-section-end></span></a></li><li><a href=#解決辦法><span class=ez-toc-section id=%E8%A7%A3%E6%B1%BA%E8%BE%A6%E6%B3%95></span>解決辦法<span class=ez-toc-section-end></span></a></li></ul></li></ul></nav></div></div><div class=content id=content><p>最近使用 Kolla-Ansible 部署 OpenStack Rocky on AArch64/ARM64 發生一些問題，這問題並不只是存在 ARM 上，而是因為發行版所維護的 QEMU 版本已經跟到了 commit <a href=https://github.com/qemu/qemu/commit/ca749954b09b89e22cd69c4949fb7e689b057963 target=_blank rel="noopener noreffer">ca749954b09b89e22cd69c4949fb7e689b057963</a> ，這個 commit 使用到了 <code>F_OFD_SETLK</code>， NFSv3 正好不支援這類型 lock 操作。</p><p>而這個修改，並沒有根據不同檔案系統不支援 <code>F_OFD_SETLK</code> 回退 <code>F_SETLK</code> 的操作，所以只要在現代 Linux 中編譯 QEMU，就會直接使用 <code>F_OFD_SETLK</code> ，而造成在 NFSv3 上無法使用 lock 進而導致失敗的現象。</p><p>而這問題也不單單只影響 Cinder-Volume，也間接影響 Nova-Compute，如果 VM 要掛載 Volume，而 Cinder 使用 NFS Driver，則會在 Nova-Compute 上也把 NFS 掛載上去給 QEMU 使用。</p><div id=ez-toc-container class="ez-toc-v2_0_17 counter-hierarchy counter-decimal ez-toc-grey"><div class=ez-toc-title-container><p class=ez-toc-title>Table of Contents</p><pre><code>&lt;span class=&quot;ez-toc-title-toggle&quot;&gt;&lt;a class=&quot;ez-toc-pull-right ez-toc-btn ez-toc-btn-xs ez-toc-btn-default ez-toc-toggle&quot; style=&quot;display: none;&quot;&gt;&lt;i class=&quot;ez-toc-glyphicon ez-toc-icon-toggle&quot;&gt;&lt;/i&gt;&lt;/a&gt;&lt;/span&gt;
</code></pre></div><nav><ul class="ez-toc-list ez-toc-list-level-1"><li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-1" href=https://blog.kojuro.date/2018/10/openstack-rocky-cinder-nfs-driver-issue/#Kolla_Cinder_NFSv3_Lock_Failed title="Kolla Cinder NFSv3 Lock Failed">Kolla Cinder NFSv3 Lock Failed</a><ul class=ez-toc-list-level-3><li class=ez-toc-heading-level-3><a class="ez-toc-link ez-toc-heading-2" href=https://blog.kojuro.date/2018/10/openstack-rocky-cinder-nfs-driver-issue/#%E5%95%8F%E9%A1%8C title=問題>問題</a></li><li class="ez-toc-page-1 ez-toc-heading-level-3"><a class="ez-toc-link ez-toc-heading-3" href=https://blog.kojuro.date/2018/10/openstack-rocky-cinder-nfs-driver-issue/#%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95 title=解決方法>解決方法</a></li></ul></li><pre><code>&lt;li class=&quot;ez-toc-page-1 ez-toc-heading-level-2&quot;&gt;
  &lt;a class=&quot;ez-toc-link ez-toc-heading-4&quot; href=&quot;https://blog.kojuro.date/2018/10/openstack-rocky-cinder-nfs-driver-issue/#QEMU_Failed_to_lock_byte_100&quot; title=&quot;QEMU Failed to lock byte 100&quot;&gt;QEMU Failed to lock byte 100&lt;/a&gt;&lt;ul class=&quot;ez-toc-list-level-3&quot;&gt;
    &lt;li class=&quot;ez-toc-heading-level-3&quot;&gt;
      &lt;a class=&quot;ez-toc-link ez-toc-heading-5&quot; href=&quot;https://blog.kojuro.date/2018/10/openstack-rocky-cinder-nfs-driver-issue/#%E5%95%8F%E9%A1%8C-2&quot; title=&quot;問題&quot;&gt;問題&lt;/a&gt;
    &lt;/li&gt;
    &lt;li class=&quot;ez-toc-page-1 ez-toc-heading-level-3&quot;&gt;
      &lt;a class=&quot;ez-toc-link ez-toc-heading-6&quot; href=&quot;https://blog.kojuro.date/2018/10/openstack-rocky-cinder-nfs-driver-issue/#%E8%A7%A3%E6%B1%BA%E8%BE%A6%E6%B3%95&quot; title=&quot;解決辦法&quot;&gt;解決辦法&lt;/a&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/li&gt;
</code></pre></ul></nav></div><h2 id=kolla-cinder-nfsv3-lock-failed><span class=ez-toc-section id=Kolla_Cinder_NFSv3_Lock_Failed></span>Kolla Cinder NFSv3 Lock Failed<span class=ez-toc-section-end></span></h2><h3 id=問題><span class=ez-toc-section id=%E5%95%8F%E9%A1%8C></span>問題<span class=ez-toc-section-end></span></h3><p>Kolla Cinder 已經在 commit <a href=https://github.com/openstack/kolla/commit/17e6e629f5660a364498b2bfd2f5aa6aede79859 target=_blank rel="noopener noreffer">17e6e629f5660a364498b2bfd2f5aa6aede79859</a> 中開啟 NFS 功能，但是將 rpcbind 取消，NFSv4 已經不需要 rpcbind ，所以將他移出必要元件之一。</p><h3 id=解決方法><span class=ez-toc-section id=%E8%A7%A3%E6%B1%BA%E6%96%B9%E6%B3%95></span>解決方法<span class=ez-toc-section-end></span></h3><p>分兩種：</p><ol><li>直接在 Host (包含 Cinder-Volume Host 以及 Nova-Compute Node)上安裝 rpcbind ，然後啟用，確保 rpcbind socket 位置在 <code>/run</code> ， Docker Container 也有 Mount Volume</li><li>安裝 rpcbind 的 Container ，直接 Container Volume Bind</li></ol><h2 id=qemu-failed-to-lock-byte-100><span class=ez-toc-section id=QEMU_Failed_to_lock_byte_100></span>QEMU Failed to lock byte 100<span class=ez-toc-section-end></span></h2><h3 id=問題-1><span class=ez-toc-section id=%E5%95%8F%E9%A1%8C-2></span>問題<span class=ez-toc-section-end></span></h3><p>如果欲將 Image 轉換成 Volume 來使用的時候，會透過 qemu-img 來轉換，這過程如果目標地在 NFS 上，則會遇到我在開頭提及的問題，進而產生 <code>QEMU Failed to lock byte 100</code></p><h3 id=解決辦法><span class=ez-toc-section id=%E8%A7%A3%E6%B1%BA%E8%BE%A6%E6%B3%95></span>解決辦法<span class=ez-toc-section-end></span></h3><p>建議是不要用 NFSv3 ，改用其他種 Backend 。雖然講的很不負責任，但是 NFSv3 事實上已經很久的技術了，雖然很成熟，但是已經不太符合現代 HA 等等需求，建議還是替換。個人也是因為經費因素，沒有辦法替換成 Ceph 或是其他的方案，則還是希望使用 NFS 作為 Cinder Backend，甚至 Nova <code>instances_path</code> 都希望直接在 NFS Storage 上。</p><p>若無法替換則使用下面方法。</p><p>重新編譯 QEMU ，強制取消使用 <code>F_OFD_SETLK</code> ，若使用 Ubuntu 等等的發行版，建議直接從發行版來源上 patch 重新編譯即可</p><pre class=wp-block-code><code>apt build-dep qemu
apt install -y fakeroot
apt source qemu
cd qemu/
# let macro will never be compiled
# replace all "#ifdef F_OFD_SETLK" to "#if 0"
sed -i.bak 's|def F_OFD_SETLK| 0|g' utils/osdep.c

DEB_BUILD_OPTIONS="parallel=8" fakeroot debian/rules clean binary
# *.deb will place at ../</code></pre><p>編譯完之後，將打包好的 deb 放入 Container 中以便安裝，以下 Container 皆需要安裝新的 package ，似乎其他 OpenStack 模組也需要上 patch ，但是我沒有細看，所以只列出我有使用到的部分</p><ul><li>nova_libvirt</li><li>nova_compute</li><li>cinder_api</li><li>cinder_volume</li><li>cinder_scheduler</li></ul><pre class=wp-block-code><code>ls *.deb | xargs -i docker cp {} &lt;Container Name>:/var/lib/kolla/</code></pre><p>根據不同的 Container 安裝需要的 QEMU package 即可，並不需要全部安裝</p><pre class=wp-block-code><code>docker exec -it -u root &lt;Container Name> bash
# inside Container
# Check installed QEMU package
apt list --installed | grep qemu
cd /var/lib/kolla/
# install patched qemu 
dpkg -i qemu-&lt;some need package name>.deb</code></pre><p>可能需要重新啟動 Container Nova-Libvirt，其餘部分就可以直接使用。</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新於 2022-07-09&nbsp;<a class=git-hash href=https://github.com/dillonzq/LoveIt/commit/2c653453dff7ea4c55a8d6fe89b3aee382d7a10a target=_blank title="commit by Date Huang(tjjh89017@hotmail.com) 2c653453dff7ea4c55a8d6fe89b3aee382d7a10a: upload wordpress posts">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>2c65345</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/2018/10/2018-10-17-openstack-rocky-cinder-nfs-driver-issue/index.md target=_blank>閱讀原始文檔</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=x data-url=https://blog.kojuro.date/2018/10/2018-10-17-openstack-rocky-cinder-nfs-driver-issue/ data-title="OpenStack Rocky Cinder NFS Driver Issue"><i class="fab fa-x-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Threads" data-sharer=threads data-url=https://blog.kojuro.date/2018/10/2018-10-17-openstack-rocky-cinder-nfs-driver-issue/ data-title="OpenStack Rocky Cinder NFS Driver Issue"><i class="fab fa-threads fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://blog.kojuro.date/2018/10/2018-10-17-openstack-rocky-cinder-nfs-driver-issue/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://blog.kojuro.date/2018/10/2018-10-17-openstack-rocky-cinder-nfs-driver-issue/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://blog.kojuro.date/2018/10/2018-10-17-openstack-rocky-cinder-nfs-driver-issue/ data-title="OpenStack Rocky Cinder NFS Driver Issue"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Diaspora" data-sharer=diaspora data-url=https://blog.kojuro.date/2018/10/2018-10-17-openstack-rocky-cinder-nfs-driver-issue/ data-title="OpenStack Rocky Cinder NFS Driver Issue" data-description><i class="fab fa-diaspora fa-fw" aria-hidden=true></i></a><a href="https://t.me/share/url?url=https%3a%2f%2fblog.kojuro.date%2f2018%2f10%2f2018-10-17-openstack-rocky-cinder-nfs-driver-issue%2f&amp;text=OpenStack%20Rocky%20Cinder%20NFS%20Driver%20Issue" target=_blank title="分享到 Telegram"><i class="fab fa-telegram fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主頁</a></span></section></div><div class=post-nav><a href=/2018/10/2018-10-14-openstack-on-aarch64-arm64-via-kolla-ansible/ class=prev rel=prev title="Openstack on AArch64/Arm64 via Kolla Ansible"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Openstack on AArch64/Arm64 via Kolla Ansible</a>
<a href=/2018/10/2018-10-18-kolla-ansible-nova-ephemeral-storage-on-nfs/ class=next rel=next title="Kolla-Ansible Nova Ephemeral Storage on NFS">Kolla-Ansible Nova Ephemeral Storage on NFS<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.155.3">Hugo</a> 強力驅動 | 主題 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.1-DEV"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2026</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Date Huang</a></span>&nbsp;|&nbsp;<span class=license>All Rights Reserved</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到頂部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i></a></div><div id=fixed-buttons-hidden><a href=# id=view-comments class=fixed-button title=查看評論><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.2/sharer.min.js></script><script>window.config={comment:{}}</script><script src=/js/theme.min.js></script><script>var dnt,doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1YYWDWN3ZY")}</script><script src="https://www.googletagmanager.com/gtag/js?id=G-1YYWDWN3ZY" async></script></body></html>